<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Din√°mico de Costos de Seguridad AWS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .upload-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 30px;
            text-align: center;
        }

        .upload-section h2 {
            margin: 0 0 15px 0;
            font-size: 2.2em;
            font-weight: 300;
        }

        .upload-section p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            background: rgba(255,255,255,0.15);
            color: white;
            padding: 15px 35px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.3);
            font-weight: 600;
            font-size: 1.1em;
            backdrop-filter: blur(10px);
            display: inline-block;
        }

        .file-input-label:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
        }

        .file-status {
            margin-top: 20px;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .file-status.success {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid rgba(40, 167, 69, 0.4);
        }

        .file-status.error {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid rgba(220, 53, 69, 0.4);
        }

        .file-status.info {
            background: rgba(23, 162, 184, 0.2);
            border: 2px solid rgba(23, 162, 184, 0.4);
        }

        .dashboard-content {
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 12px;
        }
        
        .header h1 {
            margin: 0 0 15px 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #007bff;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 500;
            font-size: 1.1em;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
            font-weight: 600;
        }
        
        .chart-wrapper {
            height: 500px;
            position: relative;
        }

        .service-details {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .service-details h3 {
            color: #333;
            border-bottom: 3px solid #28a745;
            padding-bottom: 15px;
            font-weight: 600;
            margin-top: 0;
        }

        .services-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .service-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #007bff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .service-item:hover {
            transform: translateX(5px);
        }

        .service-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .service-cost {
            font-size: 1.4em;
            color: #007bff;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .service-trend {
            font-size: 1em;
            color: #666;
        }

        .controls-section {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            color: white;
        }

        .controls-section h3 {
            margin-top: 0;
            color: white;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 15px;
            font-weight: 600;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-item label {
            font-weight: 600;
            color: white;
        }

        .control-item input {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            width: 90px;
            font-size: 1em;
        }

        .control-item button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .control-item button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .alerts-section {
            margin-bottom: 30px;
        }

        .alerts-section h3 {
            color: #333;
            border-bottom: 3px solid #ffc107;
            padding-bottom: 15px;
            font-weight: 600;
            margin-top: 0;
        }

        .alert {
            padding: 18px 25px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .alert-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        .alert-danger {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .forecast-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 35px;
            border-radius: 12px;
            margin-bottom: 40px;
        }

        .forecast-section h3 {
            margin-top: 0;
            color: white;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 15px;
            font-weight: 600;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .forecast-card {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
        }

        .forecast-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .forecast-label {
            font-size: 1.1em;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 500;
        }

        .forecast-percent {
            font-size: 1.3em;
            font-weight: 700;
            color: #ffd700;
        }

        .forecast-note {
            text-align: center;
            opacity: 0.8;
        }
        
        .table-section {
            margin-top: 40px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .table-section h3 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
            font-weight: 600;
            margin-top: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }
        
        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .positive { 
            color: #dc3545; 
            font-weight: 600; 
        }
        
        .negative { 
            color: #28a745; 
            font-weight: 600; 
        }

        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 400px;
            }
            
            .dashboard-content {
                padding: 20px;
            }
            
            .upload-section {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section">
            <h2>üìä Dashboard Din√°mico de Costos de Seguridad AWS</h2>
            <p>Sube tu archivo CSV de costos AWS y el dashboard se adaptar√° autom√°ticamente</p>
            
            <label for="csvFileInput" class="file-input-label">
                üìÅ Seleccionar archivo CSV
            </label>
            <input type="file" id="csvFileInput" class="file-input" accept=".csv" />
            
            <div id="fileStatus" class="file-status" style="display: none;"></div>
        </div>

        <div id="dashboardContent" class="dashboard-content hidden">
            <div class="header">
                <h1>Reporte de Costos de Seguridad AWS</h1>
                <p id="headerDescription">An√°lisis detallado de gastos en servicios de seguridad AWS</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSecurityCost">$0</div>
                    <div class="stat-label">Costo Total Seguridad</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPercentage">0%</div>
                    <div class="stat-label">% Promedio del Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthlyGrowth">0%</div>
                    <div class="stat-label">Crecimiento Mensual</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topService">-</div>
                    <div class="stat-label">Servicio Principal</div>
                </div>
            </div>

            <div class="service-details">
                <h3>üìä Resumen por Servicios de Seguridad</h3>
                <div class="services-summary" id="servicesSummary"></div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>üìä Costos por Servicio de Seguridad</h3>
                    <div class="chart-wrapper">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìà % de Gastos de Seguridad</h3>
                    <div class="chart-wrapper">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>üéõÔ∏è Controles</h3>
                <div class="controls-row">
                    <div class="control-item">
                        <label for="targetInput">Target de Seguridad (%):</label>
                        <input type="number" id="targetInput" value="6" min="3" max="10" step="0.5">
                        <button id="updateButton">Actualizar</button>
                    </div>
                </div>
            </div>

            <div class="alerts-section">
                <h3>‚ö†Ô∏è Alertas y An√°lisis</h3>
                <div id="alertsContainer"></div>
            </div>

            <div class="forecast-section">
                <h3>üîÆ Proyecci√≥n Pr√≥ximos 3 Meses</h3>
                <div class="forecast-grid" id="forecastGrid"></div>
                <div class="forecast-note">
                    <small id="forecastNote">üìà Proyecci√≥n basada en tendencia de crecimiento</small>
                </div>
            </div>

            <div class="table-section">
                <h3>üìã Resumen Mensual</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Per√≠odo</th>
                            <th>Costo Total</th>
                            <th>Costo Seguridad</th>
                            <th>% Seguridad</th>
                            <th>Variaci√≥n</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chartInstances = {};
        let currentData = null;
        let currentTarget = 6.0;

        const securityServicesMap = {
            'WAF($)': 'WAF',
            'GuardDuty($)': 'GuardDuty', 
            'CloudTrail($)': 'CloudTrail',
            'Inspector($)': 'Inspector',
            'Config($)': 'Config',
            'Security Hub($)': 'Security Hub',
            'Detective($)': 'Detective',
            'Key Management Service($)': 'KMS',
            'Secrets Manager($)': 'Secrets Manager',
            'Identity and Access Management Access Analyzer($)': 'IAM Access Analyzer',
            'Macie($)': 'Macie',
            'Certificate Manager($)': 'Certificate Manager',
            'Audit Manager($)': 'Audit Manager',
            'Shield($)': 'Shield',
            'Firewall Manager($)': 'Firewall Manager'
        };

        const colorPalette = [
            '#3498db', '#e74c3c', '#f39c12', '#2ecc71', '#9b59b6', 
            '#e67e22', '#1abc9c', '#34495e', '#95a5a6', '#c0392b',
            '#16a085', '#2980b9', '#8e44ad', '#d35400', '#27ae60',
            '#f1c40f', '#fd79a8', '#6c5ce7'
        ];

        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('El archivo CSV debe tener al menos headers y una fila de datos');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim().replace(/"/g, '') : '';
                    
                    if (header.includes('($)') && value && value !== '') {
                        row[header] = parseFloat(value) || 0;
                    } else {
                        row[header] = value;
                    }
                });
                data.push(row);
            }
            
            return { headers, data };
        }

        function detectSecurityServices(headers) {
            const detectedServices = [];
            const serviceColors = {};
            let colorIndex = 0;
            
            Object.keys(securityServicesMap).forEach(serviceKey => {
                if (headers.includes(serviceKey)) {
                    const displayName = securityServicesMap[serviceKey];
                    detectedServices.push({ key: serviceKey, name: displayName });
                    serviceColors[displayName] = colorPalette[colorIndex % colorPalette.length];
                    colorIndex++;
                }
            });

            const securityKeywords = [
                'security', 'guard', 'waf', 'trail', 'inspector', 'config', 
                'detective', 'macie', 'shield', 'firewall', 'access', 'audit',
                'certificate', 'secrets', 'key'
            ];
            
            headers.forEach(header => {
                if (header.includes('($)') && !Object.keys(securityServicesMap).includes(header)) {
                    const lowerHeader = header.toLowerCase();
                    if (securityKeywords.some(keyword => lowerHeader.includes(keyword))) {
                        const displayName = header.replace('($)', '').trim();
                        detectedServices.push({ key: header, name: displayName });
                        serviceColors[displayName] = colorPalette[colorIndex % colorPalette.length];
                        colorIndex++;
                    }
                }
            });
            
            return { detectedServices, serviceColors };
        }

        function extractMonthlyData(data, detectedServices) {
            const monthlyRows = data.filter(row => {
                const service = row.Service || '';
                return service.includes('2025') || service.includes('2024') || 
                       service.match(/^\d{4}-\d{2}-\d{2}/) || 
                       (service !== 'Service total' && service !== '' && !service.includes('total'));
            });

            monthlyRows.sort((a, b) => {
                const serviceA = a.Service || '';
                const serviceB = b.Service || '';
                if (serviceA.includes('2025') && serviceB.includes('2025')) {
                    return new Date(serviceA) - new Date(serviceB);
                }
                return 0;
            });

            const months = monthlyRows.map(row => {
                const service = row.Service || '';
                if (service.includes('2025') || service.includes('2024')) {
                    try {
                        const date = new Date(service);
                        return date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
                    } catch (e) {
                        return service;
                    }
                }
                return service;
            });

            const totalCosts = monthlyRows.map(row => row['Total costs($)'] || 0);
            
            const securityServicesData = {};
            detectedServices.forEach(({ key, name }) => {
                securityServicesData[name] = monthlyRows.map(row => row[key] || 0);
            });

            const securityCosts = months.map((_, monthIndex) => {
                return Object.values(securityServicesData).reduce((sum, serviceData) => {
                    return sum + (serviceData[monthIndex] || 0);
                }, 0);
            });

            const percentages = securityCosts.map((secCost, i) => 
                totalCosts[i] > 0 ? (secCost / totalCosts[i]) * 100 : 0
            );

            return {
                months,
                totalCosts,
                securityCosts,
                percentages,
                securityServicesData
            };
        }

        function updateDashboard(processedData, serviceColors) {
            const { months, totalCosts, securityCosts, percentages, securityServicesData } = processedData;
            
            updateStats(securityCosts, percentages, securityServicesData);
            createBarChart(months, securityServicesData, serviceColors);
            createLineChart(months, percentages);
            createServicesSummary(securityServicesData, serviceColors);
            fillTable(months, totalCosts, securityCosts, percentages);
            displayAlerts(percentages, securityServicesData);
            createForecast(securityCosts, percentages);
            
            document.getElementById('dashboardContent').classList.remove('hidden');
        }

        function updateStats(securityCosts, percentages, securityServicesData) {
            const totalSecurity = securityCosts.reduce((sum, cost) => sum + cost, 0);
            const avgPercentage = percentages.length > 0 ? 
                percentages.reduce((sum, p) => sum + p, 0) / percentages.length : 0;
            const monthlyGrowth = securityCosts.length > 1 ? 
                ((securityCosts[securityCosts.length - 1] - securityCosts[securityCosts.length - 2]) / 
                securityCosts[securityCosts.length - 2]) * 100 : 0;
            
            const serviceTotals = Object.entries(securityServicesData).map(([name, costs]) => ({
                name,
                total: costs.reduce((sum, cost) => sum + cost, 0)
            })).sort((a, b) => b.total - a.total);
            
            document.getElementById('totalSecurityCost').textContent = '$' + totalSecurity.toLocaleString();
            document.getElementById('avgPercentage').textContent = avgPercentage.toFixed(1) + '%';
            document.getElementById('monthlyGrowth').textContent = (monthlyGrowth >= 0 ? '+' : '') + monthlyGrowth.toFixed(1) + '%';
            document.getElementById('topService').textContent = serviceTotals.length > 0 ? serviceTotals[0].name : '-';
            
            const avgCard = document.querySelector('.stats-grid .stat-card:nth-child(2)');
            const statValue = avgCard.querySelector('.stat-value');
            const deviation = avgPercentage - currentTarget;
            
            if (deviation > 0) {
                statValue.style.color = '#dc3545';
                avgCard.style.borderLeftColor = '#dc3545';
            } else {
                statValue.style.color = '#28a745';
                avgCard.style.borderLeftColor = '#28a745';
            }
        }

        function createServicesSummary(securityServicesData, serviceColors) {
            const container = document.getElementById('servicesSummary');
            container.innerHTML = '';
            
            Object.entries(securityServicesData).forEach(([serviceName, costs]) => {
                const totalCost = costs.reduce((sum, cost) => sum + cost, 0);
                const lastMonthCost = costs[costs.length - 1] || 0;
                const firstMonthCost = costs.find(c => c > 0) || 0;
                const growth = firstMonthCost > 0 ? ((lastMonthCost - firstMonthCost) / firstMonthCost) * 100 : 0;
                
                if (totalCost > 0) {
                    const serviceDiv = document.createElement('div');
                    serviceDiv.className = 'service-item';
                    serviceDiv.style.borderLeftColor = serviceColors[serviceName] || '#007bff';
                    
                    const trendClass = growth > 0 ? 'positive' : growth < 0 ? 'negative' : '';
                    const trendIcon = growth > 0 ? 'üìà' : growth < 0 ? 'üìâ' : '‚û°Ô∏è';
                    
                    serviceDiv.innerHTML = `
                        <div class="service-name">${serviceName}</div>
                        <div class="service-cost">$${totalCost.toLocaleString()}</div>
                        <div class="service-trend ${trendClass}">
                            ${trendIcon} ${growth.toFixed(1)}% | √öltimo: $${lastMonthCost.toLocaleString()}
                        </div>
                    `;
                    
                    container.appendChild(serviceDiv);
                }
            });
        }

        function createBarChart(months, securityServicesData, serviceColors) {
            if (chartInstances.barChart) {
                chartInstances.barChart.destroy();
            }
            
            const ctx = document.getElementById('barChart').getContext('2d');
            
            const datasets = Object.entries(securityServicesData)
                .filter(([_, costs]) => costs.reduce((sum, cost) => sum + cost, 0) > 0)
                .map(([serviceName, costs]) => ({
                    label: serviceName,
                    data: costs,
                    backgroundColor: serviceColors[serviceName] || '#007bff'
                }));
            
            chartInstances.barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function createLineChart(months, percentages) {
            if (chartInstances.lineChart) {
                chartInstances.lineChart.destroy();
            }
            
            const ctx = document.getElementById('lineChart').getContext('2d');
            chartInstances.lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '% Seguridad',
                        data: percentages,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#2980b9',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.max(0, Math.min(...percentages) - 0.5),
                            max: Math.max(...percentages) + 0.5,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function fillTable(months, totalCosts, securityCosts, percentages) {
            const tableBody = document.getElementById('dataTable');
            tableBody.innerHTML = '';
            
            months.forEach((month, index) => {
                const row = document.createElement('tr');
                
                let variation = 'N/A';
                let variationClass = '';
                let observation = 'Per√≠odo base';
                
                if (index > 0 && percentages[index - 1] > 0) {
                    const change = ((percentages[index] - percentages[index - 1]) / percentages[index - 1]) * 100;
                    variation = (change >= 0 ? '+' : '') + change.toFixed(1) + '%';
                    variationClass = change >= 0 ? 'positive' : 'negative';
                    
                    if (Math.abs(change) < 5) observation = 'Variaci√≥n normal';
                    else if (change > 20) observation = 'Incremento muy alto';
                    else if (change > 10) observation = 'Incremento significativo';
                    else if (change > 5) observation = 'Incremento moderado';
                    else if (change < -20) observation = 'Reducci√≥n muy alta';
                    else if (change < -10) observation = 'Reducci√≥n significativa';
                    else observation = 'Reducci√≥n moderada';
                }
                
                if (percentages[index] > currentTarget + 1) {
                    observation = `üö® Sobre target ${currentTarget}%`;
                } else if (percentages[index] > currentTarget) {
                    observation = `‚ö†Ô∏è Cerca del l√≠mite`;
                }
                
                row.innerHTML = `
                    <td><strong>${month}</strong></td>
                    <td>${totalCosts[index].toLocaleString()}</td>
                    <td>${securityCosts[index].toLocaleString()}</td>
                    <td><strong>${percentages[index].toFixed(2)}%</strong></td>
                    <td class="${variationClass}">${variation}</td>
                    <td>${observation}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function generateAlerts(percentages, securityServicesData) {
            const alerts = [];
            
            const lastPercentage = percentages[percentages.length - 1];
            if (lastPercentage > currentTarget + 0.5) {
                alerts.push({
                    type: 'danger',
                    message: `üö® CR√çTICO: √öltimo per√≠odo ${lastPercentage.toFixed(2)}% supera significativamente el target del ${currentTarget}%`
                });
            } else if (lastPercentage > currentTarget) {
                alerts.push({
                    type: 'warning',
                    message: `‚ö†Ô∏è √öltimo per√≠odo: ${lastPercentage.toFixed(2)}% supera ligeramente el target del ${currentTarget}%`
                });
            } else {
                alerts.push({
                    type: 'success',
                    message: `‚úÖ √öltimo per√≠odo: ${lastPercentage.toFixed(2)}% dentro del target del ${currentTarget}%`
                });
            }
            
            const serviceGrowths = Object.entries(securityServicesData).map(([name, costs]) => {
                const firstNonZero = costs.find(c => c > 0) || 0;
                const lastCost = costs[costs.length - 1] || 0;
                const growth = firstNonZero > 0 ? ((lastCost - firstNonZero) / firstNonZero) * 100 : 0;
                return { name, growth, lastCost, total: costs.reduce((sum, c) => sum + c, 0) };
            }).filter(s => s.lastCost > 0).sort((a, b) => b.growth - a.growth);

            if (serviceGrowths.length > 0) {
                const topGrowth = serviceGrowths[0];
                if (topGrowth.growth > 100) {
                    alerts.push({
                        type: 'danger',
                        message: `üìà ALTO CRECIMIENTO: ${topGrowth.name} creci√≥ ${topGrowth.growth.toFixed(0)}% en el per√≠odo`
                    });
                } else if (topGrowth.growth > 50) {
                    alerts.push({
                        type: 'warning',
                        message: `üìà ${topGrowth.name} tuvo crecimiento notable: ${topGrowth.growth.toFixed(0)}%`
                    });
                }

                const topService = serviceGrowths.sort((a, b) => b.total - a.total)[0];
                alerts.push({
                    type: 'info',
                    message: `üí∞ Servicio m√°s costoso: ${topService.name} (${topService.total.toLocaleString()} total)`
                });
            }

            const newServices = Object.entries(securityServicesData).filter(([name, costs]) => {
                const midPoint = Math.floor(costs.length / 2);
                const firstHalf = costs.slice(0, midPoint);
                const secondHalf = costs.slice(midPoint);
                const firstHalfSum = firstHalf.reduce((sum, c) => sum + c, 0);
                const secondHalfSum = secondHalf.reduce((sum, c) => sum + c, 0);
                return firstHalfSum === 0 && secondHalfSum > 0;
            });

            if (newServices.length > 0) {
                alerts.push({
                    type: 'info',
                    message: `üÜï Servicios nuevos activados: ${newServices.map(([name]) => name).join(', ')}`
                });
            }

            if (percentages.length > 1) {
                const firstPercentage = percentages[0];
                const lastPercentage = percentages[percentages.length - 1];
                const totalChange = firstPercentage > 0 ? 
                    ((lastPercentage - firstPercentage) / firstPercentage) * 100 : 0;
                
                if (totalChange > 50) {
                    alerts.push({
                        type: 'danger',
                        message: `‚ö†Ô∏è TENDENCIA CR√çTICA: Incremento total del ${totalChange.toFixed(1)}% en el per√≠odo`
                    });
                } else if (totalChange > 25) {
                    alerts.push({
                        type: 'warning',
                        message: `üìä Incremento notable del ${totalChange.toFixed(1)}% en el per√≠odo`
                    });
                } else {
                    alerts.push({
                        type: 'info',
                        message: `üìä Cambio total del per√≠odo: ${totalChange.toFixed(1)}%`
                    });
                }
            }
            
            return alerts;
        }

        function displayAlerts(percentages, securityServicesData) {
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';
            
            const alerts = generateAlerts(percentages, securityServicesData);
            
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type}`;
                alertDiv.innerHTML = alert.message;
                alertsContainer.appendChild(alertDiv);
            });
        }

        function createForecast(securityCosts, percentages) {
            const forecastGrid = document.getElementById('forecastGrid');
            forecastGrid.innerHTML = '';
            
            if (securityCosts.length < 2) return;
            
            const growthRates = [];
            for (let i = 1; i < securityCosts.length; i++) {
                if (securityCosts[i - 1] > 0) {
                    growthRates.push((securityCosts[i] - securityCosts[i - 1]) / securityCosts[i - 1]);
                }
            }
            
            let weightedGrowth = 0;
            let totalWeight = 0;
            growthRates.forEach((rate, index) => {
                const weight = index + 1;
                weightedGrowth += rate * weight;
                totalWeight += weight;
            });
            const avgGrowthRate = totalWeight > 0 ? weightedGrowth / totalWeight : 0;
            
            const lastCost = securityCosts[securityCosts.length - 1];
            const lastPercentage = percentages[percentages.length - 1];
            const monthNames = ['Pr√≥ximo mes', 'En 2 meses', 'En 3 meses'];
            
            for (let i = 0; i < 3; i++) {
                const projectedCost = lastCost * Math.pow(1 + avgGrowthRate, i + 1);
                const projectedPercent = lastPercentage * Math.pow(1 + avgGrowthRate, i + 1);
                
                const forecastCard = document.createElement('div');
                forecastCard.className = 'forecast-card';
                
                if (projectedPercent > currentTarget) {
                    forecastCard.style.borderColor = '#ffc107';
                    forecastCard.style.background = 'rgba(255, 193, 7, 0.2)';
                }
                
                forecastCard.innerHTML = `
                    <div class="forecast-value">${projectedCost.toLocaleString()}</div>
                    <div class="forecast-label">${monthNames[i]}</div>
                    <div class="forecast-percent">${projectedPercent.toFixed(1)}%</div>
                `;
                forecastGrid.appendChild(forecastCard);
            }
            
            const growthPercent = (avgGrowthRate * 100).toFixed(1);
            document.getElementById('forecastNote').textContent = 
                `üìà Proyecci√≥n basada en tendencia ponderada de ${growthPercent}% mensual`;
        }

        function updateTarget() {
            const newTarget = parseFloat(document.getElementById('targetInput').value);
            if (newTarget >= 3 && newTarget <= 10 && currentData) {
                currentTarget = newTarget;
                
                const { percentages, securityServicesData, securityCosts } = currentData;
                displayAlerts(percentages, securityServicesData);
                updateStats(securityCosts, percentages, securityServicesData);
                createForecast(securityCosts, percentages);
            }
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    showFileStatus('üîÑ Procesando archivo...', 'info');
                    
                    const csvText = e.target.result;
                    const { headers, data } = parseCSVData(csvText);
                    
                    const { detectedServices, serviceColors } = detectSecurityServices(headers);
                    
                    if (detectedServices.length === 0) {
                        showFileStatus('‚ùå No se detectaron servicios de seguridad en el CSV', 'error');
                        return;
                    }
                    
                    const processedData = extractMonthlyData(data, detectedServices);
                    
                    if (processedData.months.length === 0) {
                        showFileStatus('‚ùå No se detectaron datos mensuales v√°lidos', 'error');
                        return;
                    }
                    
                    currentData = processedData;
                    
                    const firstMonth = processedData.months[0];
                    const lastMonth = processedData.months[processedData.months.length - 1];
                    document.getElementById('headerDescription').textContent = 
                        `An√°lisis detallado de gastos en servicios de seguridad AWS - ${firstMonth} a ${lastMonth}`;
                    
                    updateDashboard(processedData, serviceColors);
                    
                    showFileStatus(`‚úÖ Archivo procesado exitosamente. ${detectedServices.length} servicios detectados en ${processedData.months.length} per√≠odos`, 'success');
                    
                } catch (error) {
                    console.error('Error:', error);
                    showFileStatus(`‚ùå Error procesando archivo: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function showFileStatus(message, type) {
            const statusDiv = document.getElementById('fileStatus');
            statusDiv.innerHTML = message;
            statusDiv.className = `file-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.opacity = '0.7';
                }, 3000);
            }
        }

        function loadSampleData() {
            const sampleData = {
                months: ['Feb 2025', 'Mar 2025', 'Abr 2025', 'May 2025', 'Jun 2025', 'Jul 2025'],
                totalCosts: [38453, 41437, 42292, 48385, 47223, 52000],
                securityCosts: [567, 636, 727, 942, 1056, 1199],
                percentages: [1.47, 1.54, 1.72, 1.95, 2.24, 2.31],
                securityServicesData: {
                    'WAF': [48, 48, 48, 49, 48, 48],
                    'GuardDuty': [219, 259, 364, 490, 529, 550],
                    'Config': [30, 25, 35, 40, 45, 50],
                    'Security Hub': [3, 8, 15, 25, 30, 35],
                    'Inspector': [46, 52, 53, 57, 59, 67],
                    'CloudTrail': [49, 56, 68, 75, 84, 74],
                    'KMS': [2, 2, 2, 2, 2, 2],
                    'Detective': [0, 0, 0, 15, 25, 35],
                    'Macie': [0, 0, 11, 38, 41, 46],
                    'Audit Manager': [0, 0, 0, 0, 26, 76]
                }
            };
            
            const sampleColors = {
                'WAF': '#3498db',
                'GuardDuty': '#e74c3c', 
                'Config': '#f39c12',
                'Security Hub': '#2ecc71',
                'Inspector': '#9b59b6',
                'CloudTrail': '#e67e22',
                'KMS': '#95a5a6',
                'Detective': '#34495e',
                'Macie': '#1abc9c',
                'Audit Manager': '#c0392b'
            };
            
            currentData = sampleData;
            updateDashboard(sampleData, sampleColors);
            showFileStatus('üìã Mostrando datos de ejemplo. Sube tu archivo CSV para ver datos reales.', 'info');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('csvFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.name.toLowerCase().endsWith('.csv') || file.type === 'text/csv') {
                        processCSVFile(file);
                    } else {
                        showFileStatus('‚ùå Por favor selecciona un archivo CSV v√°lido', 'error');
                    }
                }
            });
            
            document.getElementById('updateButton').addEventListener('click', updateTarget);
            
            loadSampleData();
        });
    </script>
</body>
</html>